<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>FocusAI Debug</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 20px;
      color: #fff;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    h1 {
      margin: 0 0 20px 0;
      font-size: 32px;
      font-weight: 700;
    }
    .section {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .section h2 {
      margin: 0 0 15px 0;
      font-size: 20px;
      font-weight: 600;
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .info-row:last-child {
      border-bottom: none;
    }
    .label {
      font-weight: 600;
      opacity: 0.8;
    }
    .value {
      font-family: 'Courier New', monospace;
      word-break: break-all;
    }
    button {
      background: #1db954;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      margin: 5px;
      transition: all 0.2s;
    }
    button:hover {
      background: #1ed760;
      transform: scale(1.05);
    }
    button:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
    }
    .status {
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      display: inline-block;
      margin: 10px 0;
    }
    .status.good {
      background: rgba(29, 185, 84, 0.3);
    }
    .status.bad {
      background: rgba(255, 107, 107, 0.3);
    }
    pre {
      background: rgba(0, 0, 0, 0.3);
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 12px;
      line-height: 1.5;
    }
    .copy-btn {
      background: rgba(255, 255, 255, 0.2);
      font-size: 14px;
      padding: 8px 16px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç FocusAI Debug Panel</h1>
    
    <div class="section">
      <h2>Extension Info</h2>
      <div class="info-row">
        <span class="label">Extension ID:</span>
        <span class="value" id="ext-id">-</span>
      </div>
      <div class="info-row">
        <span class="label">Redirect URI:</span>
        <span class="value" id="redirect-uri">-</span>
      </div>
      <button class="copy-btn" onclick="copyRedirectUri()">Copy Redirect URI</button>
    </div>
    
    <div class="section">
      <h2>Authentication Status</h2>
      <div id="auth-status" class="status bad">Not Authenticated</div>
      <div class="info-row">
        <span class="label">Token Exists:</span>
        <span class="value" id="has-token">-</span>
      </div>
      <div class="info-row">
        <span class="label">Token Age:</span>
        <span class="value" id="token-age">-</span>
      </div>
      <div class="info-row">
        <span class="label">Token Expires In:</span>
        <span class="value" id="token-expires">-</span>
      </div>
      <button onclick="testToken()">Test Token</button>
      <button onclick="clearToken()" style="background: #e74c3c;">Clear Token</button>
    </div>
    
    <div class="section">
      <h2>Storage Contents</h2>
      <pre id="storage-contents">Loading...</pre>
      <button onclick="loadStorage()">Refresh Storage</button>
    </div>
    
    <div class="section">
      <h2>Quick Actions</h2>
      <button onclick="openPopup()">Open Popup</button>
      <button onclick="forceLogin()" style="background: #1db954;">Force Login</button>
      <button onclick="forceLogout()" style="background: #e74c3c;">Force Logout</button>
      <button onclick="testAPI()">Test Spotify API</button>
    </div>
    
    <div class="section">
      <h2>Console Output</h2>
      <pre id="console-output"></pre>
    </div>
  </div>

  <script>
    const log = (...args) => {
      const output = document.getElementById('console-output');
      const line = args.map(a => typeof a === 'object' ? JSON.stringify(a, null, 2) : a).join(' ');
      output.textContent += line + '\n';
      console.log(...args);
    };

    async function loadInfo() {
      const extId = chrome.runtime.id;
      // MUST match Spotify Dashboard exactly
      const redirectUri = 'https://fcebfginidcappmbokiokjpgjfbmadbj.chromiumapp.org/callback';
      
      document.getElementById('ext-id').textContent = extId;
      document.getElementById('redirect-uri').textContent = redirectUri;
      
      await loadStorage();
      await checkAuth();
    }

    async function loadStorage() {
      try {
        const data = await chrome.storage.local.get(null);
        document.getElementById('storage-contents').textContent = JSON.stringify(data, null, 2);
        
        const hasToken = !!data.spotifyToken;
        document.getElementById('has-token').textContent = hasToken ? 'Yes' : 'No';
        
        if (data.tokenTimestamp) {
          const age = Math.floor((Date.now() - data.tokenTimestamp) / 1000);
          const ageMin = Math.floor(age / 60);
          document.getElementById('token-age').textContent = `${ageMin} minutes (${age}s)`;
          
          const expiresIn = 3600 - age;
          const expiresMin = Math.floor(expiresIn / 60);
          document.getElementById('token-expires').textContent = expiresIn > 0 
            ? `${expiresMin} minutes (${expiresIn}s)` 
            : 'EXPIRED';
        } else {
          document.getElementById('token-age').textContent = 'N/A';
          document.getElementById('token-expires').textContent = 'N/A';
        }
      } catch (e) {
        log('Error loading storage:', e);
      }
    }

    async function checkAuth() {
      try {
        const { spotifyToken, tokenTimestamp } = await chrome.storage.local.get({
          spotifyToken: '',
          tokenTimestamp: 0
        });
        
        const hasToken = !!spotifyToken;
        const notExpired = (Date.now() - tokenTimestamp) < 3600000;
        const isAuthed = hasToken && notExpired;
        
        const statusEl = document.getElementById('auth-status');
        if (isAuthed) {
          statusEl.textContent = '‚úÖ Authenticated';
          statusEl.className = 'status good';
        } else {
          statusEl.textContent = '‚ùå Not Authenticated';
          statusEl.className = 'status bad';
        }
      } catch (e) {
        log('Error checking auth:', e);
      }
    }

    async function testToken() {
      log('Testing token...');
      try {
        const { spotifyToken } = await chrome.storage.local.get({ spotifyToken: '' });
        if (!spotifyToken) {
          log('‚ùå No token found');
          return;
        }
        
        const res = await fetch('https://api.spotify.com/v1/me', {
          headers: { 'Authorization': 'Bearer ' + spotifyToken }
        });
        
        if (res.ok) {
          const user = await res.json();
          log('‚úÖ Token is valid!');
          log('User:', user.display_name, '(' + user.email + ')');
          log('Account type:', user.product);
        } else {
          const error = await res.text();
          log('‚ùå Token is invalid:', res.status, error);
        }
      } catch (e) {
        log('‚ùå Error testing token:', e);
      }
      await checkAuth();
    }

    async function clearToken() {
      if (!confirm('Are you sure you want to clear the token?')) return;
      
      log('Clearing token...');
      await chrome.storage.local.remove(['spotifyToken', 'tokenTimestamp', 'spotifyRefreshToken', 'spotifyCodeVerifier']);
      log('‚úÖ Token cleared');
      await loadStorage();
      await checkAuth();
    }

    function copyRedirectUri() {
      const uri = document.getElementById('redirect-uri').textContent;
      navigator.clipboard.writeText(uri);
      log('‚úÖ Copied redirect URI to clipboard');
    }

    function openPopup() {
      chrome.action.openPopup();
    }

    async function forceLogin() {
      log('üîê Forcing login flow...');
      try {
        // Clear any existing token first
        await chrome.storage.local.remove(['spotifyToken', 'tokenTimestamp', 'spotifyRefreshToken']);
        log('‚úÖ Cleared existing tokens');
        
        // Open popup which will show login screen
        chrome.action.openPopup();
        log('‚úÖ Popup opened - click the Login button or the green "Login with Spotify" button');
      } catch (e) {
        log('‚ùå Error:', e);
      }
    }

    async function forceLogout() {
      log('üö™ Forcing logout...');
      try {
        await chrome.storage.local.remove(['spotifyToken', 'tokenTimestamp', 'spotifyRefreshToken', 'spotifyCodeVerifier']);
        log('‚úÖ Logged out - all tokens cleared');
        await loadStorage();
        await checkAuth();
        log('‚úÖ Open popup to see login screen');
      } catch (e) {
        log('‚ùå Error:', e);
      }
    }

    async function testAPI() {
      log('Testing Spotify API connection...');
      try {
        const { spotifyToken } = await chrome.storage.local.get({ spotifyToken: '' });
        if (!spotifyToken) {
          log('‚ùå No token available. Please login first.');
          return;
        }
        
        // Test Web API
        log('Testing Web API - Get current user...');
        const userRes = await fetch('https://api.spotify.com/v1/me', {
          headers: { 'Authorization': 'Bearer ' + spotifyToken }
        });
        log('User API response:', userRes.status);
        
        // Test player endpoint
        log('Testing Player API - Get devices...');
        const devicesRes = await fetch('https://api.spotify.com/v1/me/player/devices', {
          headers: { 'Authorization': 'Bearer ' + spotifyToken }
        });
        const devices = await devicesRes.json();
        log('Devices:', devices);
        
        if (devices.devices && devices.devices.length > 0) {
          log('‚úÖ Found', devices.devices.length, 'device(s)');
          devices.devices.forEach(d => {
            log('  -', d.name, '(' + d.type + ')', d.is_active ? '[ACTIVE]' : '');
          });
        } else {
          log('‚ö†Ô∏è No active Spotify devices found. Please open Spotify somewhere.');
        }
      } catch (e) {
        log('‚ùå Error testing API:', e);
      }
    }

    // Load info on page load
    loadInfo();
    
    // Refresh every 5 seconds
    setInterval(() => {
      loadStorage();
      checkAuth();
    }, 5000);
  </script>
</body>
</html>

