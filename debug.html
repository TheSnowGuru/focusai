<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FocusAI - Debug Mode</title>
  <link rel="stylesheet" href="popup.css">
  <style>
    /* Debug-specific styles */
    body {
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .debug-container {
      max-width: 400px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .debug-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      text-align: center;
    }

    .debug-header h1 {
      margin: 0 0 10px 0;
      font-size: 24px;
    }

    .debug-badge {
      display: inline-block;
      background: rgba(255,255,255,0.2);
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .debug-console {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 400px;
      max-height: 300px;
      background: #1e1e1e;
      color: #d4d4d4;
      border-radius: 8px;
      padding: 15px;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      overflow-y: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 9999;
    }

    .debug-console-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #333;
    }

    .debug-console-title {
      font-weight: bold;
      color: #4ec9b0;
    }

    .debug-console-clear {
      background: #333;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 10px;
    }

    .debug-console-clear:hover {
      background: #444;
    }

    .debug-log {
      margin: 5px 0;
      line-height: 1.4;
    }

    .debug-log.info { color: #569cd6; }
    .debug-log.success { color: #4ec9b0; }
    .debug-log.warning { color: #dcdcaa; }
    .debug-log.error { color: #f48771; }

    .app {
      /* Override extension-specific sizing */
      width: 100% !important;
      min-height: 500px !important;
    }

    /* Storage indicator */
    .storage-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      font-size: 12px;
      max-width: 300px;
    }

    .storage-indicator h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: #667eea;
    }

    .storage-item {
      margin: 5px 0;
      padding: 5px;
      background: #f5f5f5;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 10px;
      word-break: break-all;
    }
  </style>
</head>
<body>
  <div class="debug-header">
    <h1>üîç FocusAI Debug Mode</h1>
    <span class="debug-badge">localStorage Testing</span>
  </div>

  <div class="debug-container">
    <div class="app" id="app">
      <!-- Timer View -->
      <div id="view-timer">
        <!-- Motivation Header -->
        <div id="motivation" class="motivation-header">
          <span id="motivation-text">Add your first task</span>
        </div>

        <div class="main-content">
          <!-- Tab Bar -->
          <div id="tab-bar" class="tab-bar"></div>

          <!-- Task Section -->
          <div class="task-section">
            <div class="task-header">
              <div class="task-title-section">
                <h2>My Tasks</h2>
                <div class="drag-hint" title="Drag tasks to reorder by importance">‚ãÆ‚ãÆ</div>
              </div>
            </div>

            <!-- Inline Add Task Input -->
            <div class="add-task-row">
              <input id="add-task-input" type="text" placeholder="Add a task and press Enter" />
              <button id="add-task-btn" class="primary-btn"><span class="btn-icon">+</span> Add</button>
            </div>

            <div class="tasks-container">
              <ul id="task-list"></ul>
            </div>

            <div id="confetti" aria-hidden="true"></div>
          </div>
        </div>

        <!-- Pomodoro Footer (at very bottom) -->
        <div class="pomodoro-footer">
          <div class="pomodoro-left">
            <button id="start-stop" class="primary-btn">Start</button>
            <div id="time" class="timer-time">25:00</div>
            <div class="duration-controls">
              <button id="duration-down" class="duration-btn">-</button>
              <input id="duration-input" type="text" value="25" class="duration-input" />
              <button id="duration-up" class="duration-btn">+</button>
            </div>
          </div>
          <div class="pomodoro-right">
            <button id="play-music" class="music-btn" aria-label="Play music">üéµ</button>
            <button id="prev" class="ghost" aria-label="Previous track">‚èÆÔ∏è</button>
            <button id="next" class="ghost" aria-label="Next track">‚è≠Ô∏è</button>
          </div>
        </div>
      </div>

      <!-- Hidden Spotify Player -->
      <div id="spotify-player" class="spotify-player hidden">
        <div class="player-header">
          <span class="player-title">Now Playing</span>
          <button id="close-player" class="close-btn">√ó</button>
        </div>
        <div id="spotify-embed" class="spotify-embed"></div>
      </div>

      <!-- Login View (hidden by default in debug mode) -->
      <div id="view-login" class="login-card hidden">
        <div class="login-content">
          <h2>Login to Spotify</h2>
          <p>Connect your Spotify account to play focus music during your sessions.</p>
          <button id="login-spotify" class="spotify-btn">
            Login with Spotify
          </button>
          <div class="redirect-info">
            Redirect URI: <code id="redirect-uri">Debug Mode - No OAuth</code>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Debug Console -->
  <div class="debug-console" id="debug-console">
    <div class="debug-console-header">
      <span class="debug-console-title">üìã Debug Console</span>
      <button class="debug-console-clear" onclick="clearDebugConsole()">Clear</button>
    </div>
    <div id="debug-logs"></div>
  </div>

  <!-- Storage Indicator -->
  <div class="storage-indicator">
    <h3>üíæ localStorage State</h3>
    <div id="storage-display"></div>
  </div>

  <script type="module">
    // Mock Chrome APIs for debugging
    window.chrome = {
      storage: {
        local: {
          get: async (keys) => {
            const result = {};
            if (typeof keys === 'object' && !Array.isArray(keys)) {
              for (const key in keys) {
                const stored = localStorage.getItem(key);
                result[key] = stored ? JSON.parse(stored) : keys[key];
              }
            } else {
              const keysArray = Array.isArray(keys) ? keys : [keys];
              for (const key of keysArray) {
                const stored = localStorage.getItem(key);
                if (stored) result[key] = JSON.parse(stored);
              }
            }
            debugLog('üì• storage.get', result, 'info');
            updateStorageDisplay();
            return result;
          },
          set: async (items) => {
            for (const key in items) {
              localStorage.setItem(key, JSON.stringify(items[key]));
            }
            debugLog('üíæ storage.set', items, 'success');
            updateStorageDisplay();
            return true;
          },
          remove: async (keys) => {
            const keysArray = Array.isArray(keys) ? keys : [keys];
            for (const key of keysArray) {
              localStorage.removeItem(key);
            }
            debugLog('üóëÔ∏è storage.remove', keysArray, 'warning');
            updateStorageDisplay();
            return true;
          },
          clear: async () => {
            localStorage.clear();
            debugLog('üóëÔ∏è storage.clear', 'All cleared', 'warning');
            updateStorageDisplay();
            return true;
          }
        }
      },
      runtime: {
        getURL: (path) => path,
        sendMessage: async (message) => {
          debugLog('üì§ sendMessage', message, 'info');
          return { ok: true };
        }
      },
      alarms: {
        create: (name, alarmInfo) => {
          debugLog('‚è∞ alarm.create', { name, alarmInfo }, 'info');
        },
        clear: (name, callback) => {
          debugLog('‚è∞ alarm.clear', name, 'info');
          if (callback) callback();
        }
      },
      identity: {
        getRedirectURL: (path) => `https://debug.local/${path}`
      },
      tabs: {
        create: async (options) => {
          debugLog('üåê tabs.create', options, 'info');
          return { id: 1 };
        }
      }
    };

    // Debug logging functions
    window.debugLog = function(title, data, type = 'info') {
      const logsDiv = document.getElementById('debug-logs');
      const log = document.createElement('div');
      log.className = `debug-log ${type}`;
      
      const timestamp = new Date().toLocaleTimeString();
      log.innerHTML = `<strong>[${timestamp}]</strong> ${title}: ${typeof data === 'object' ? JSON.stringify(data, null, 2) : data}`;
      
      logsDiv.appendChild(log);
      logsDiv.scrollTop = logsDiv.scrollHeight;
    };

    window.clearDebugConsole = function() {
      document.getElementById('debug-logs').innerHTML = '';
      debugLog('üîÑ', 'Console cleared', 'info');
    };

    function updateStorageDisplay() {
      const display = document.getElementById('storage-display');
      const tasks = localStorage.getItem('tasks');
      const activeTab = localStorage.getItem('activeTab');
      const customTabs = localStorage.getItem('customTabs');
      
      let html = '';
      if (tasks) {
        html += `<div class="storage-item"><strong>tasks:</strong> ${tasks}</div>`;
      }
      if (activeTab) {
        html += `<div class="storage-item"><strong>activeTab:</strong> ${activeTab}</div>`;
      }
      if (customTabs) {
        html += `<div class="storage-item"><strong>customTabs:</strong> ${customTabs}</div>`;
      }
      
      if (!html) {
        html = '<div class="storage-item">No data in storage</div>';
      }
      
      display.innerHTML = html;
    }

    // Override console methods to also log to debug console
    const originalConsoleLog = console.log;
    const originalConsoleError = console.error;
    const originalConsoleWarn = console.warn;

    console.log = function(...args) {
      originalConsoleLog.apply(console, args);
      debugLog('LOG', args.join(' '), 'info');
    };

    console.error = function(...args) {
      originalConsoleError.apply(console, args);
      debugLog('ERROR', args.join(' '), 'error');
    };

    console.warn = function(...args) {
      originalConsoleWarn.apply(console, args);
      debugLog('WARN', args.join(' '), 'warning');
    };

    // Initialize
    debugLog('üöÄ', 'Debug mode initialized', 'success');
    updateStorageDisplay();

    // Import and initialize the extension modules
    import('./js/timer.js').then(({ TimerManager }) => {
      window.timerManager = new TimerManager();
      window.timerManager.init();
      debugLog('‚è±Ô∏è', 'TimerManager initialized', 'success');
    });

    import('./js/tabs.js').then(({ TabManager }) => {
      window.tabManager = new TabManager();
      window.tabManager.init();
      debugLog('üìë', 'TabManager initialized', 'success');
    });

    import('./js/ui.js').then(({ UIManager }) => {
      UIManager.init();
      debugLog('üé®', 'UIManager initialized', 'success');
    });

    // Periodic storage display update
    setInterval(updateStorageDisplay, 2000);
  </script>
</body>
</html>
